<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>Kolek-Ta - Waste Collection Management</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: {
              50: '#f0fdf4',
              100: '#dcfce7',
              200: '#bbf7d0',
              300: '#86efac',
              400: '#4ade80',
              500: '#22c55e',
              600: '#16a34a',
              700: '#15803d',
              800: '#166534',
              900: '#14532d'
            }
          }
        }
      }
    }
  </script>

  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  <style>
    /* Base styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      overflow: hidden;
    }

    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    .animate-fade-in {
      animation: fadeIn 0.3s ease-out;
    }

    .animate-slide-in {
      animation: slideInRight 0.3s ease-out;
    }

    .animate-pulse-slow {
      animation: pulse 2s infinite;
    }

    /* Map container */
    #map {
      height: 100%;
      width: 100%;
      z-index: 1;
    }

    /* Custom scrollbar */
    .custom-scrollbar::-webkit-scrollbar {
      width: 6px;
    }

    .custom-scrollbar::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 3px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 3px;
    }

    .custom-scrollbar::-webkit-scrollbar-thumb:hover {
      background: #a1a1a1;
    }

    /* Modal styles */
    .modal {
      display: none;
    }

    .modal.active {
      display: flex;
    }

    /* Custom route marker styles */
    .custom-route-marker {
      background: transparent !important;
      border: none !important;
    }

    .custom-route-marker > div {
      transition: transform 0.2s ease;
    }

    .custom-route-marker:hover > div {
      transform: scale(1.2);
    }

    /* Hide Leaflet Routing Machine instructions panel */
    .leaflet-routing-container {
      display: none !important;
    }

    .leaflet-routing-alt {
      display: none !important;
    }

    /* Custom truck marker styles */
    .custom-truck-marker {
      background: transparent !important;
      border: none !important;
    }

    /* Slide in animation */
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    .animate-slide-in {
      animation: slideIn 0.3s ease-out;
    }

    /* Scale-in animation for dialogs */
    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    .animate-scale-in {
      animation: scaleIn 0.2s ease-out;
    }

    /* Fade-out animation */
    @keyframes fadeOutAnim {
      from {
        opacity: 1;
      }
      to {
        opacity: 0;
      }
    }

    .animate-fade-out {
      animation: fadeOutAnim 0.2s ease-out forwards;
    }

    /* Leaflet custom styles */
    .leaflet-control-zoom a {
      width: 36px !important;
      height: 36px !important;
      line-height: 36px !important;
      font-size: 18px !important;
      border-radius: 8px !important;
    }

    .leaflet-control-zoom {
      border: none !important;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15) !important;
      border-radius: 8px !important;
      overflow: hidden;
    }

    /* Landmark icon styles */
    .landmark-icon {
      background: transparent;
      border: none;
    }

    /* GPS button pulse animation */
    .gps-active {
      animation: pulse 1.5s infinite;
    }

    /* Notification badge pulse */
    .notification-pulse {
      animation: pulse 2s infinite;
    }

    /* Mobile sidebar toggle */
    .sidebar-overlay {
      display: none;
    }

    .sidebar-overlay.active {
      display: block;
    }

    /* Hide on mobile */
    @media (max-width: 768px) {
      .hide-mobile {
        display: none !important;
      }
    }

    /* Show only on mobile */
    @media (min-width: 769px) {
      .show-mobile-only {
        display: none !important;
      }
    }

    /* Mobile Driver Navigation Styles */
    .mobile-nav-btn {
      color: #6b7280;
    }

    .mobile-nav-btn.active {
      color: #4f46e5;
      background-color: #eef2ff;
    }

    .mobile-nav-btn:active {
      transform: scale(0.95);
    }

    /* Safe area for notched phones */
    .safe-area-bottom {
      padding-bottom: env(safe-area-inset-bottom, 0);
    }

    /* Mobile panel slide animation */
    .mobile-panel-visible {
      transform: translateY(0) !important;
    }

    /* Mobile responsive modal */
    @media (max-width: 640px) {
      #modal > div {
        max-height: 95vh !important;
        margin: 0.5rem;
        border-radius: 1rem;
      }

      #modal > div > div:first-child {
        padding: 1rem 1.25rem;
      }

      #modalBody {
        padding: 1rem 1.25rem;
      }

      /* Make modal full screen on mobile for better UX */
      #modal.modal-fullscreen > div {
        max-width: 100%;
        max-height: 100%;
        height: 100%;
        margin: 0;
        border-radius: 0;
      }
    }

    /* Touch-friendly buttons */
    @media (max-width: 768px) {
      .btn-touch {
        min-height: 48px;
        min-width: 48px;
      }

      /* Larger tap targets for mobile */
      button, [role="button"] {
        touch-action: manipulation;
      }

      /* Navigation panel mobile adjustments */
      #navigationPanel {
        bottom: 80px !important;
        left: 0.5rem !important;
        right: 0.5rem !important;
        transform: none !important;
        width: auto !important;
        max-width: none !important;
      }

      /* Route info panel mobile adjustments */
      #routeInfoPanel {
        bottom: 80px !important;
        left: 0.5rem !important;
        right: 0.5rem !important;
        transform: none !important;
        width: auto !important;
        max-width: none !important;
      }

      /* Truck info panel mobile adjustments */
      #truckInfoPanel {
        bottom: 80px !important;
        left: 0.5rem !important;
        right: 0.5rem !important;
        transform: none !important;
        width: auto !important;
        max-width: none !important;
      }

      /* Live tracking panel mobile adjustments */
      #liveTrackingPanel {
        top: auto !important;
        bottom: 80px !important;
        right: 0.5rem !important;
        left: 0.5rem !important;
        width: auto !important;
        max-height: 50vh !important;
      }
    }

    /* Swipe indicator */
    .swipe-indicator {
      width: 3rem;
      height: 0.25rem;
      background: #d1d5db;
      border-radius: 9999px;
      margin: 0 auto 1rem;
    }

    /* Mobile active route indicator on map */
    .mobile-route-indicator {
      position: fixed;
      top: 70px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 15;
      background: white;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
  </style>
</head>
<body class="bg-gray-100">

  <!-- Global Page Loading Overlay -->
  <div id="pageLoadingOverlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center z-[9999] transition-opacity duration-300" style="display: none;">
    <div class="flex flex-col items-center">
      <div class="relative">
        <div class="w-12 h-12 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin"></div>
      </div>
      <p id="loadingText" class="mt-3 text-gray-600 font-medium text-sm">Loading...</p>
    </div>
  </div>

  <div class="h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-gradient-to-r from-primary-600 to-primary-500 text-white px-4 py-3 flex items-center justify-between z-20 shadow-lg flex-shrink-0">
      <!-- Left: Logo & Title -->
      <div class="flex items-center gap-3">
        <!-- Mobile menu toggle -->
        <button id="menuToggle" class="lg:hidden p-2 hover:bg-white/10 rounded-lg transition-colors">
          <i data-lucide="menu" class="w-6 h-6"></i>
        </button>

        <div class="flex items-center gap-2">
          <div class="w-10 h-10 bg-white/20 rounded-full flex items-center justify-center">
            <i data-lucide="recycle" class="w-5 h-5"></i>
          </div>
          <div>
            <h1 class="font-bold text-lg leading-tight">Kolek-Ta</h1>
            <p class="text-primary-100 text-xs hide-mobile">Waste Collection Management</p>
          </div>
        </div>
      </div>

      <!-- Right: User info -->
      <div class="flex items-center gap-2 sm:gap-3">
        <!-- Notification (admin only) -->
        <div id="headerNotificationContainer"></div>

        <!-- User Profile -->
        <button onclick="showProfile()" class="flex items-center gap-2 bg-white/10 hover:bg-white/20 px-3 py-2 rounded-lg transition-colors">
          <span id="headerProfilePic" class="w-8 h-8 rounded-full bg-white/30 flex items-center justify-center font-bold text-sm"></span>
          <span id="headerUserName" class="text-sm font-medium hide-mobile"></span>
        </button>

        <!-- Logout -->
        <button onclick="logout()" class="p-2 hover:bg-white/10 rounded-lg transition-colors" title="Logout">
          <i data-lucide="log-out" class="w-5 h-5"></i>
        </button>
      </div>
    </header>

    <!-- Main Content -->
    <div class="flex-1 flex overflow-hidden">

      <!-- Sidebar Overlay (mobile) -->
      <div id="sidebarOverlay" class="sidebar-overlay fixed inset-0 bg-black/50 z-30 lg:hidden" onclick="toggleSidebar()"></div>

      <!-- Sidebar -->
      <aside id="sidebar" class="fixed lg:relative inset-y-0 left-0 z-40 w-72 bg-white shadow-xl transform -translate-x-full lg:translate-x-0 transition-transform duration-300 ease-in-out flex flex-col">

        <!-- Sidebar Header (mobile) -->
        <div class="lg:hidden flex items-center justify-between p-4 border-b border-gray-100">
          <span class="font-semibold text-gray-800">Menu</span>
          <button onclick="toggleSidebar()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
            <i data-lucide="x" class="w-5 h-5 text-gray-500"></i>
          </button>
        </div>

        <!-- Sidebar Content -->
        <div class="flex-1 overflow-y-auto custom-scrollbar p-4 space-y-4">

          <!-- Admin Controls -->
          <div id="adminControls" class="hidden">
            <!-- Dashboard -->
            <div class="space-y-1 mb-4">
              <button id="dashboardBtn" class="w-full flex items-center gap-3 px-4 py-3 bg-primary-50 text-primary-700 rounded-lg transition-colors text-left">
                <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                <span class="font-medium">Dashboard</span>
              </button>
            </div>

            <!-- Operations Group -->
            <div class="mb-4">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 px-2">Operations</h3>
              <div class="space-y-1">
                <button id="routesManagementBtn" class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-primary-50 hover:text-primary-700 rounded-lg transition-colors text-left">
                  <i data-lucide="map-pin" class="w-5 h-5"></i>
                  <span class="font-medium">Routes Management</span>
                </button>
                <button id="liveTruckTrackingBtn" class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-primary-50 hover:text-primary-700 rounded-lg transition-colors text-left">
                  <i data-lucide="radio" class="w-5 h-5"></i>
                  <span class="font-medium">Live Truck Tracking</span>
                </button>
                <button id="schedulesBtn" class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-primary-50 hover:text-primary-700 rounded-lg transition-colors text-left">
                  <i data-lucide="calendar-clock" class="w-5 h-5"></i>
                  <span class="font-medium">Collection Schedules</span>
                </button>
              </div>
            </div>

            <!-- Fleet & Drivers Group -->
            <div class="mb-4">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 px-2">Fleet & Drivers</h3>
              <div class="space-y-1">
                <button id="truckManagementBtn" class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-primary-50 hover:text-primary-700 rounded-lg transition-colors text-left">
                  <i data-lucide="truck" class="w-5 h-5"></i>
                  <span class="font-medium">Truck Management</span>
                </button>
                <button id="userManagementBtn" class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-primary-50 hover:text-primary-700 rounded-lg transition-colors text-left">
                  <i data-lucide="users" class="w-5 h-5"></i>
                  <span class="font-medium">User Management</span>
                </button>
                <button id="fuelManagementBtn" class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-primary-50 hover:text-primary-700 rounded-lg transition-colors text-left">
                  <i data-lucide="fuel" class="w-5 h-5"></i>
                  <span class="font-medium">Fuel Management</span>
                </button>
              </div>
            </div>

            <!-- History & Reports Group -->
            <div class="mb-4">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 px-2">History & Reports</h3>
              <div class="space-y-1">
                <button id="completionHistoryBtn" class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-primary-50 hover:text-primary-700 rounded-lg transition-colors text-left">
                  <i data-lucide="file-text" class="w-5 h-5"></i>
                  <span class="font-medium">Completion History</span>
                </button>
                <button id="reportsBtn" class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-primary-50 hover:text-primary-700 rounded-lg transition-colors text-left">
                  <i data-lucide="file-bar-chart" class="w-5 h-5"></i>
                  <span class="font-medium">Reports</span>
                </button>
                <button id="analyticsBtn" class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-primary-50 hover:text-primary-700 rounded-lg transition-colors text-left">
                  <i data-lucide="chart-pie" class="w-5 h-5"></i>
                  <span class="font-medium">Analytics</span>
                </button>
              </div>
            </div>

            <!-- Public Services Group -->
            <div class="mb-4">
              <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider mb-2 px-2">Public Services</h3>
              <div class="space-y-1">
                <button id="complaintsBtn" class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-primary-50 hover:text-primary-700 rounded-lg transition-colors text-left relative">
                  <i data-lucide="message-square-warning" class="w-5 h-5"></i>
                  <span class="font-medium">Public Complaints</span>
                  <span id="complaintsBadge" class="hidden absolute right-3 top-1/2 -translate-y-1/2 min-w-5 h-5 px-1 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                </button>
                <button id="specialPickupsBtn" class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-primary-50 hover:text-primary-700 rounded-lg transition-colors text-left relative">
                  <i data-lucide="package" class="w-5 h-5"></i>
                  <span class="font-medium">Special Pickups</span>
                  <span id="specialPickupsBadge" class="hidden absolute right-3 top-1/2 -translate-y-1/2 min-w-5 h-5 px-1 bg-blue-500 text-white text-xs font-bold rounded-full flex items-center justify-center">0</span>
                </button>
                <button id="announcementsAdminBtn" class="w-full flex items-center gap-3 px-4 py-3 text-gray-700 hover:bg-primary-50 hover:text-primary-700 rounded-lg transition-colors text-left">
                  <i data-lucide="megaphone" class="w-5 h-5"></i>
                  <span class="font-medium">Announcements</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Driver Panel -->
          <div id="driverPanel" class="hidden space-y-4">
            <!-- Driver Quick Stats -->
            <div id="driverQuickStats" class="grid grid-cols-2 gap-2">
              <div class="bg-gradient-to-br from-green-50 to-green-100 rounded-xl p-3 border border-green-200">
                <p class="text-xs text-green-600 font-medium">Today</p>
                <p id="driverTodayRoutes" class="text-xl font-bold text-green-700">0</p>
                <p class="text-xs text-green-500">routes done</p>
              </div>
              <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-xl p-3 border border-blue-200">
                <p class="text-xs text-blue-600 font-medium">Distance</p>
                <p id="driverTodayDistance" class="text-xl font-bold text-blue-700">0</p>
                <p class="text-xs text-blue-500">km today</p>
              </div>
            </div>

            <!-- GPS Status Card -->
            <div id="gpsStatusPanel" class="bg-gray-50 rounded-xl p-3 border-l-4 border-gray-300">
              <div class="flex items-center gap-3">
                <div id="gpsStatusIconWrapper" class="w-9 h-9 bg-gray-200 rounded-full flex items-center justify-center">
                  <i data-lucide="map-pin" class="w-4 h-4 text-gray-500" id="gpsStatusIcon"></i>
                </div>
                <div class="flex-1">
                  <p id="gpsStatusText" class="font-semibold text-gray-800 text-sm">Checking GPS...</p>
                  <p id="gpsStatusDetail" class="text-xs text-gray-500">Initializing</p>
                </div>
                <button onclick="testGPSConnection()" class="p-2 hover:bg-gray-200 rounded-lg transition-colors" title="Test GPS">
                  <i data-lucide="refresh-cw" class="w-4 h-4 text-gray-500"></i>
                </button>
              </div>
            </div>

            <!-- Active Route Panel (shown when route is active) -->
            <div id="activeRoutePanel" class="hidden bg-gradient-to-br from-orange-50 to-yellow-50 rounded-xl p-4 border border-orange-200">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                  <span class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></span>
                  <span class="text-sm font-semibold text-orange-700">Active Route</span>
                </div>
                <span id="activeRouteProgress" class="text-xs bg-orange-500 text-white px-2 py-1 rounded-full font-medium">0/0</span>
              </div>
              <p id="activeRouteName" class="font-bold text-gray-800 mb-2">-</p>
              <div class="flex items-center gap-4 text-xs text-gray-600 mb-3">
                <span id="activeRouteDistance" class="flex items-center gap-1"><i data-lucide="map" class="w-3 h-3"></i> - km</span>
                <span id="activeRouteETA" class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> - mins</span>
              </div>
              <div class="flex gap-2">
                <button onclick="showActiveRouteNavigation()" class="flex-1 flex items-center justify-center gap-1 px-3 py-2 bg-orange-500 hover:bg-orange-600 text-white text-sm font-medium rounded-lg transition-colors">
                  <i data-lucide="navigation" class="w-4 h-4"></i>
                  Navigate
                </button>
                <button onclick="markRouteComplete(localStorage.getItem('activeRouteId'))" class="flex-1 flex items-center justify-center gap-1 px-3 py-2 bg-green-500 hover:bg-green-600 text-white text-sm font-medium rounded-lg transition-colors">
                  <i data-lucide="check-circle" class="w-4 h-4"></i>
                  Complete
                </button>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="grid grid-cols-2 gap-2">
              <button onclick="showVehicleInspection()" class="flex flex-col items-center gap-1 p-3 bg-white border border-gray-200 hover:bg-gray-50 rounded-xl transition-colors">
                <i data-lucide="clipboard-check" class="w-5 h-5 text-primary-600"></i>
                <span class="text-xs font-medium text-gray-700">Inspection</span>
              </button>
              <button onclick="showDriverStats()" class="flex flex-col items-center gap-1 p-3 bg-white border border-gray-200 hover:bg-gray-50 rounded-xl transition-colors">
                <i data-lucide="bar-chart-3" class="w-5 h-5 text-primary-600"></i>
                <span class="text-xs font-medium text-gray-700">My Stats</span>
              </button>
              <button onclick="reportIncident()" class="flex flex-col items-center gap-1 p-3 bg-white border border-gray-200 hover:bg-red-50 rounded-xl transition-colors">
                <i data-lucide="alert-triangle" class="w-5 h-5 text-red-500"></i>
                <span class="text-xs font-medium text-gray-700">Report</span>
              </button>
              <button id="viewDriverHistoryBtn" onclick="showDriverHistory()" class="flex flex-col items-center gap-1 p-3 bg-white border border-gray-200 hover:bg-gray-50 rounded-xl transition-colors">
                <i data-lucide="history" class="w-5 h-5 text-primary-600"></i>
                <span class="text-xs font-medium text-gray-700">History</span>
              </button>
            </div>

            <!-- Section Header -->
            <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider pt-2">My Assignments</h3>

            <!-- Driver Assignments -->
            <div id="driverAssignments" class="space-y-3 max-h-[300px] overflow-y-auto custom-scrollbar">
              <div class="text-center py-4 text-gray-400">
                <i data-lucide="loader" class="w-6 h-6 mx-auto mb-2 animate-spin"></i>
                <p class="text-sm">Loading assignments...</p>
              </div>
            </div>
          </div>

        </div>

        <!-- GPS Button (Driver only, fixed at bottom) -->
        <div id="gpsButtonContainer" class="hidden p-4 border-t border-gray-100">
          <button id="startGpsBtn" onclick="toggleGPSTracking()" class="w-full flex items-center justify-center gap-2 bg-primary-500 hover:bg-primary-600 text-white font-semibold py-4 rounded-xl transition-colors shadow-lg">
            <i data-lucide="navigation" class="w-5 h-5"></i>
            <span>Start GPS Tracking</span>
          </button>
        </div>
      </aside>

      <!-- Main Content Area -->
      <main class="flex-1 relative overflow-hidden">
        <!-- Map Container -->
        <div id="mapContainer" class="absolute inset-0">
          <div id="map" class="h-full w-full"></div>

          <!-- Map Loading Overlay -->
          <div id="mapLoadingOverlay" class="absolute inset-0 bg-gray-100 flex flex-col items-center justify-center z-50 transition-opacity duration-500">
            <div class="relative">
              <div class="w-16 h-16 border-4 border-primary-200 border-t-primary-600 rounded-full animate-spin"></div>
              <div class="absolute inset-0 flex items-center justify-center">
                <i data-lucide="map" class="w-6 h-6 text-primary-600"></i>
              </div>
            </div>
            <p class="mt-4 text-gray-600 font-medium">Loading Map...</p>
            <p class="mt-1 text-gray-400 text-sm">Please wait while tiles load</p>
          </div>

          <!-- Offline Sync Indicator (shown when there are pending offline actions) -->
          <div id="offlineSyncIndicator" class="hidden fixed top-4 right-4 z-50">
            <div class="bg-amber-500 text-white px-4 py-2 rounded-xl shadow-lg flex items-center gap-2 animate-pulse">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              <span class="text-sm font-medium"><span id="offlinePendingCount">0</span> pending sync</span>
            </div>
          </div>

          <!-- Driver Web Overlay Controls (shown on desktop for drivers) -->
          <div id="driverWebOverlay" class="hidden absolute top-4 left-4 z-30 w-80">
            <!-- GPS Status Card -->
            <div id="overlayGpsStatus" class="bg-white/95 backdrop-blur-md rounded-xl shadow-lg p-3 mb-3 border border-gray-200">
              <div class="flex items-center gap-3">
                <div id="overlayGpsIconWrapper" class="w-10 h-10 bg-gray-200 rounded-full flex items-center justify-center">
                  <i data-lucide="map-pin" class="w-5 h-5 text-gray-500" id="overlayGpsIcon"></i>
                </div>
                <div class="flex-1">
                  <p id="overlayGpsText" class="font-semibold text-gray-800 text-sm">GPS Status</p>
                  <p id="overlayGpsDetail" class="text-xs text-gray-500">Initializing...</p>
                </div>
                <button onclick="toggleOverlayGPS()" id="overlayGpsBtn" class="px-4 py-2 bg-primary-500 hover:bg-primary-600 text-white text-sm font-medium rounded-lg transition-colors flex items-center gap-2">
                  <i data-lucide="navigation" class="w-4 h-4"></i>
                  <span>Start</span>
                </button>
              </div>
            </div>

            <!-- Live Fuel Estimation Panel -->
            <div id="overlayFuelEstimate" class="hidden bg-white/95 backdrop-blur-md rounded-xl shadow-lg p-3 mb-3 border border-emerald-300">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <i data-lucide="fuel" class="w-4 h-4 text-emerald-600"></i>
                  <span class="text-xs font-semibold text-emerald-700 uppercase">Live Fuel Estimation</span>
                </div>
                <span id="fuelEstimateBadge" class="px-2 py-0.5 bg-emerald-100 text-emerald-700 text-[10px] font-medium rounded-full">Auto</span>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div class="bg-gradient-to-br from-emerald-50 to-emerald-100 rounded-lg p-2 text-center">
                  <p class="text-lg font-bold text-emerald-700" id="liveFuelLiters">0.00</p>
                  <p class="text-[10px] text-emerald-600">Liters Used</p>
                </div>
                <div class="bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg p-2 text-center">
                  <p class="text-lg font-bold text-blue-700" id="liveDistanceKm">0.00</p>
                  <p class="text-[10px] text-blue-600">Km Traveled</p>
                </div>
              </div>
              <div class="grid grid-cols-3 gap-2 mt-2">
                <div class="text-center">
                  <p class="text-sm font-semibold text-gray-700" id="liveStopCount">0</p>
                  <p class="text-[9px] text-gray-500">Stops</p>
                </div>
                <div class="text-center">
                  <p class="text-sm font-semibold text-gray-700" id="liveAvgSpeed">0</p>
                  <p class="text-[9px] text-gray-500">Avg km/h</p>
                </div>
                <div class="text-center">
                  <p class="text-sm font-semibold text-gray-700" id="liveEfficiency">0</p>
                  <p class="text-[9px] text-gray-500">km/L</p>
                </div>
              </div>
              <div class="mt-2 pt-2 border-t border-emerald-200 flex items-center justify-between text-[10px]">
                <span class="text-gray-500" id="liveTripDuration">Duration: 0m</span>
                <span class="text-gray-500" id="liveIdleTime">Idle: 0m</span>
              </div>
            </div>

            <!-- Active Route Panel -->
            <div id="overlayActiveRoute" class="hidden bg-white/95 backdrop-blur-md rounded-xl shadow-lg p-4 mb-3 border border-orange-300">
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-2">
                  <span class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></span>
                  <span class="text-sm font-semibold text-orange-700">Active Route</span>
                </div>
                <span id="overlayRouteProgress" class="text-xs text-orange-600 font-medium">0/0 stops</span>
              </div>
              <p id="overlayRouteName" class="font-bold text-gray-800 text-sm mb-2">-</p>
              <!-- Progress Bar -->
              <div class="w-full bg-gray-200 rounded-full h-2 mb-3">
                <div id="overlayProgressBar" class="bg-orange-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
              </div>
              <div class="flex items-center gap-4 text-xs text-gray-600 mb-3">
                <span id="overlayRouteDistance" class="flex items-center gap-1"><i data-lucide="map" class="w-3 h-3"></i> - km</span>
                <span id="overlayRouteETA" class="flex items-center gap-1"><i data-lucide="clock" class="w-3 h-3"></i> - mins</span>
              </div>
              <div class="flex gap-2">
                <button onclick="showActiveRouteNavigation()" class="flex-1 flex items-center justify-center gap-1 px-3 py-2 bg-orange-500 hover:bg-orange-600 text-white text-xs font-medium rounded-lg transition-colors">
                  <i data-lucide="navigation" class="w-3 h-3"></i>
                  Navigate
                </button>
                <button onclick="markRouteComplete(localStorage.getItem('activeRouteId'))" class="flex-1 flex items-center justify-center gap-1 px-3 py-2 bg-green-500 hover:bg-green-600 text-white text-xs font-medium rounded-lg transition-colors">
                  <i data-lucide="check-circle" class="w-3 h-3"></i>
                  Complete
                </button>
              </div>
            </div>

            <!-- Quick Actions -->
            <div class="bg-white/95 backdrop-blur-md rounded-xl shadow-lg p-3 border border-gray-200">
              <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider mb-2">Quick Actions</p>
              <div class="grid grid-cols-4 gap-2">
                <button onclick="showVehicleInspection()" class="flex flex-col items-center gap-1 p-2 hover:bg-gray-100 rounded-lg transition-colors">
                  <i data-lucide="clipboard-check" class="w-5 h-5 text-primary-600"></i>
                  <span class="text-[10px] font-medium text-gray-600">Inspect</span>
                </button>
                <button onclick="showDriverStats()" class="flex flex-col items-center gap-1 p-2 hover:bg-gray-100 rounded-lg transition-colors">
                  <i data-lucide="bar-chart-3" class="w-5 h-5 text-primary-600"></i>
                  <span class="text-[10px] font-medium text-gray-600">Stats</span>
                </button>
                <button onclick="reportIncident()" class="flex flex-col items-center gap-1 p-2 hover:bg-red-50 rounded-lg transition-colors">
                  <i data-lucide="alert-triangle" class="w-5 h-5 text-red-500"></i>
                  <span class="text-[10px] font-medium text-gray-600">Report</span>
                </button>
                <button onclick="showDriverHistory()" class="flex flex-col items-center gap-1 p-2 hover:bg-gray-100 rounded-lg transition-colors">
                  <i data-lucide="history" class="w-5 h-5 text-primary-600"></i>
                  <span class="text-[10px] font-medium text-gray-600">History</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Driver Assignments Overlay (bottom right on desktop) -->
          <div id="driverAssignmentsOverlay" class="hidden lg:block absolute bottom-4 right-4 z-30 w-80 max-h-[300px]">
            <div class="bg-white/95 backdrop-blur-md rounded-xl shadow-lg border border-gray-200 overflow-hidden">
              <div class="px-4 py-2 bg-gray-50 border-b border-gray-200 flex items-center justify-between">
                <p class="text-xs font-semibold text-gray-500 uppercase tracking-wider">My Assignments</p>
                <button onclick="toggleAssignmentsOverlay()" class="text-gray-400 hover:text-gray-600">
                  <i data-lucide="chevron-down" class="w-4 h-4" id="assignmentsToggleIcon"></i>
                </button>
              </div>
              <div id="overlayAssignments" class="p-3 max-h-[240px] overflow-y-auto custom-scrollbar space-y-2">
                <div class="text-center py-4 text-gray-400">
                  <i data-lucide="loader" class="w-5 h-5 mx-auto mb-1 animate-spin"></i>
                  <p class="text-xs">Loading...</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Driver Stats Overlay (top right on desktop) -->
          <div id="driverStatsOverlay" class="hidden lg:block absolute top-4 right-4 z-30">
            <div class="flex gap-2">
              <div class="bg-white/95 backdrop-blur-md rounded-xl shadow-lg px-4 py-2 border border-green-200">
                <p class="text-[10px] text-green-600 font-medium uppercase">Today</p>
                <p id="overlayTodayRoutes" class="text-lg font-bold text-green-700">0</p>
                <p class="text-[10px] text-green-500">routes</p>
              </div>
              <div class="bg-white/95 backdrop-blur-md rounded-xl shadow-lg px-4 py-2 border border-blue-200">
                <p class="text-[10px] text-blue-600 font-medium uppercase">Distance</p>
                <p id="overlayTodayDistance" class="text-lg font-bold text-blue-700">0</p>
                <p class="text-[10px] text-blue-500">km</p>
              </div>
            </div>
          </div>

          <!-- Mobile Driver Minimal Overlay (top of screen) -->
          <div id="mobileDriverOverlay" class="hidden fixed top-2 left-2 right-2 z-20 lg:hidden">
            <!-- Compact Status Bar -->
            <div class="flex items-center gap-2">
              <!-- GPS Status Pill -->
              <div id="mobileGpsStatusPill" onclick="toggleGPSTracking()" class="flex items-center gap-1.5 bg-white/95 backdrop-blur-sm rounded-full px-3 py-1.5 shadow-md border border-gray-200 cursor-pointer active:scale-95 transition-transform">
                <div id="mobileGpsDot" class="w-2 h-2 bg-gray-400 rounded-full"></div>
                <span id="mobileGpsLabel" class="text-xs font-medium text-gray-600">GPS Off</span>
              </div>

              <!-- Active Route Pill (shown when route is active) -->
              <div id="mobileRoutePill" class="hidden flex-1 flex items-center gap-2 bg-orange-500/95 backdrop-blur-sm rounded-full px-3 py-1.5 shadow-md cursor-pointer active:scale-95 transition-transform" onclick="showMobileActiveRoute()">
                <div class="w-2 h-2 bg-white rounded-full animate-pulse"></div>
                <span id="mobileRouteLabel" class="text-xs font-medium text-white truncate">Route Active</span>
                <i data-lucide="chevron-right" class="w-3 h-3 text-white/80 flex-shrink-0"></i>
              </div>

              <!-- Stats Pill -->
              <div id="mobileStatsPill" class="flex items-center gap-2 bg-white/95 backdrop-blur-sm rounded-full px-3 py-1.5 shadow-md border border-gray-200">
                <span class="text-xs font-bold text-green-600" id="mobileStatsRoutes">0</span>
                <span class="text-[10px] text-gray-400">routes</span>
              </div>
            </div>
          </div>

          <!-- Mobile Driver Bottom Navigation -->
          <div id="mobileDriverNav" class="hidden fixed bottom-0 left-0 right-0 z-20 lg:hidden">
            <!-- Bottom Nav Bar -->
            <div class="bg-white border-t border-gray-200 shadow-lg safe-area-bottom">
              <div class="flex items-center justify-around py-2">
                <button onclick="showMobileDriverHome()" class="mobile-nav-btn flex flex-col items-center gap-1 p-2 rounded-lg transition-colors" data-nav="home">
                  <i data-lucide="home" class="w-5 h-5"></i>
                  <span class="text-xs font-medium">Home</span>
                </button>
                <button onclick="showMobileActiveRoute()" class="mobile-nav-btn flex flex-col items-center gap-1 p-2 rounded-lg transition-colors" data-nav="route">
                  <i data-lucide="navigation" class="w-5 h-5"></i>
                  <span class="text-xs font-medium">Route</span>
                </button>
                <button onclick="showVehicleInspection()" class="mobile-nav-btn flex flex-col items-center gap-1 p-2 rounded-lg transition-colors" data-nav="inspect">
                  <i data-lucide="clipboard-check" class="w-5 h-5"></i>
                  <span class="text-xs font-medium">Inspect</span>
                </button>
                <button onclick="showDriverStats()" class="mobile-nav-btn flex flex-col items-center gap-1 p-2 rounded-lg transition-colors" data-nav="stats">
                  <i data-lucide="bar-chart-3" class="w-5 h-5"></i>
                  <span class="text-xs font-medium">Stats</span>
                </button>
                <button onclick="toggleSidebar()" class="mobile-nav-btn flex flex-col items-center gap-1 p-2 rounded-lg transition-colors" data-nav="menu">
                  <i data-lucide="menu" class="w-5 h-5"></i>
                  <span class="text-xs font-medium">More</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Mobile Driver Quick Panel (slides up) -->
          <div id="mobileDriverPanel" class="hidden fixed bottom-16 left-0 right-0 z-15 lg:hidden transform translate-y-full transition-transform duration-300">
            <div class="bg-white rounded-t-2xl shadow-2xl p-4 max-h-[60vh] overflow-y-auto">
              <div class="w-12 h-1 bg-gray-300 rounded-full mx-auto mb-4"></div>
              <div id="mobileDriverContent"></div>
            </div>
          </div>
        </div>

        <!-- Page Content Container (hidden by default) -->
        <div id="pageContainer" class="hidden absolute inset-0 bg-gray-50 overflow-y-auto">
          <div id="pageContent" class="p-6 max-w-7xl mx-auto"></div>
        </div>
      </main>

    </div>
  </div>

  <!-- Modal -->
  <!-- Modern Modal -->
  <div id="modal" class="modal fixed inset-0 bg-black/50 backdrop-blur-sm z-50 items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg max-h-[90vh] flex flex-col animate-scale-in overflow-hidden">
      <!-- Modal Header -->
      <div class="flex items-center justify-between px-6 py-4 bg-gradient-to-r from-primary-600 to-primary-500 text-white flex-shrink-0">
        <h2 id="modalTitle" class="text-lg font-bold">Modal Title</h2>
        <button onclick="closeModal()" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
          <i data-lucide="x" class="w-5 h-5"></i>
        </button>
      </div>
      <!-- Modal Body -->
      <div id="modalBody" class="flex-1 overflow-y-auto p-6 custom-scrollbar"></div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
  <!-- Leaflet Heatmap plugin for analytics -->
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
  <!-- Chart.js for report visualizations -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="app.js"></script>
  <script>
    // Initialize Lucide icons
    lucide.createIcons();

    // Sidebar toggle function
    function toggleSidebar() {
      const sidebar = document.getElementById('sidebar');
      const overlay = document.getElementById('sidebarOverlay');

      sidebar.classList.toggle('-translate-x-full');
      overlay.classList.toggle('active');
    }

    // Close sidebar when clicking menu items on mobile
    document.querySelectorAll('#sidebar button').forEach(btn => {
      btn.addEventListener('click', () => {
        if (window.innerWidth < 1024) {
          toggleSidebar();
        }
      });
    });

    // Menu toggle
    document.getElementById('menuToggle').addEventListener('click', toggleSidebar);
  </script>
</body>
</html>
